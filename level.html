<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Level — HTML/CSS/JS</title>
<style>
  :root{
    --bg:#0f1115;
    --ring:#1f2430;
    --tick:#2f3644;
    --text:#e8ecf3;
    --accent:#6ee7b7;      /* xanh khi cân bằng */
    --warn:#f59e0b;        /* vàng khi lệch vừa */
    --danger:#ef4444;      /* đỏ khi lệch nhiều */
  }

  html,body {height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:flex; flex-direction:column; align-items:center; justify-content:space-between; gap:8px;
    -webkit-user-select:none; user-select:none;
    touch-action:manipulation;
  }

  header{
    padding:14px 16px 0; width:100%; max-width:480px; box-sizing:border-box;
    display:flex; justify-content:space-between; align-items:center; gap:8px;
  }
  .title { font-weight:600; letter-spacing:.2px; opacity:.9 }
  .mode-chip{
    font-size:12px; padding:6px 10px; border-radius:999px;
    background:#1a1f29; border:1px solid #222836; opacity:.9
  }
  .container{
    width:100%; max-width:480px; aspect-ratio:1/1; position:relative; margin:auto;
    display:grid; place-items:center; padding:12px; box-sizing:border-box;
  }

  /* Vòng chính */
  .dial{
    width:100%; height:100%; border-radius:50%;
    background:radial-gradient(120% 120% at 50% 50%, #151922 0%, #0e1118 60%, #0c0f15 100%);
    position:relative; box-shadow: inset 0 0 0 1px #1c2230, inset 0 0 40px rgba(0,0,0,.35);
  }
  /* Vạch độ */
  .dial::before, .dial::after{
    content:""; position:absolute; inset:10%; border-radius:50%;
    box-shadow:
      0 -35% 0 -31% var(--tick),
      0  35% 0 -31% var(--tick),
      35% 0 0 -31% var(--tick),
      -35% 0 0 -31% var(--tick);
  }
  .ring{
    position:absolute; inset:6%; border-radius:50%;
    border:2px solid var(--ring);
  }

  /* Bong bóng */
  .bubble-wrap{
    position:absolute; inset:22%; border-radius:50%; pointer-events:none;
  }
  .bubble{
    --shadow: rgba(0,0,0,.55);
    position:absolute; left:50%; top:50%; transform:translate(-50%, -50%);
    width:28%; height:28%; border-radius:50%;
    background: radial-gradient(120% 120% at 30% 30%, rgba(255,255,255,.45), rgba(255,255,255,.12) 35%, rgba(255,255,255,.08) 55%, rgba(255,255,255,0) 70%),
                radial-gradient(100% 100% at 70% 70%, rgba(110,231,183,.35), rgba(110,231,183,.05) 60%, rgba(110,231,183,0) 75%);
    box-shadow:
      inset 0 2px 8px rgba(255,255,255,.25),
      0 8px 18px var(--shadow), 0 2px 8px var(--shadow);
    border:1px solid rgba(255,255,255,.12);
    transition: box-shadow .15s ease;
  }

  /* Thanh dọc khi ở chế độ Vertical (dựng đứng) */
  .vertical-guide{
    position:absolute; left:50%; top:8%; bottom:8%; width:3px; transform:translateX(-50%);
    background:linear-gradient(to bottom, #273041, #1b2230);
    border-radius:2px; opacity:.7; display:none;
  }

  /* HUD */
  .hud{
    position:absolute; bottom:18px; left:50%; transform:translateX(-50%);
    display:flex; gap:10px; align-items:center; font-variant-numeric: tabular-nums;
    background:#121722; border:1px solid #22283a; border-radius:12px; padding:8px 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,.35);
  }
  .deg{ font-size:20px; font-weight:600 }
  .axis{ font-size:12px; opacity:.8 }
  .dot{ width:6px; height:6px; border-radius:50%; background:#344055 }

  /* Controls */
  .controls{
    width:100%; max-width:480px; box-sizing:border-box; padding:0 16px 20px;
    display:flex; gap:10px; justify-content:space-between; align-items:center;
  }
  button{
    appearance:none; border:none; cursor:pointer; color:var(--text); font-weight:600;
    background:#1b2230; border:1px solid #222a3a; padding:12px 14px; border-radius:12px;
    box-shadow: 0 4px 14px rgba(0,0,0,.25);
  }
  button:active{ transform:translateY(1px) }
  .primary{ background:#0f1729; border-color:#223049 }
  .ghost{ background:#161c28 }

  .notice{
    font-size:13px; opacity:.8; line-height:1.35; padding:0 16px 12px; max-width:520px; text-align:center;
  }

  /* Adaptive colors */
  .ok { outline:2px solid var(--accent); outline-offset:-2px }
  .warn { outline:2px solid var(--warn); outline-offset:-2px }
  .bad { outline:2px solid var(--danger); outline-offset:-2px }

  @media (max-width:360px){
    .bubble{ width:32%; height:32% }
    .hud{ bottom:14px }
  }
</style>
</head>
<body>
  <header>
    <div class="title">Level</div>
    <div class="mode-chip" id="modeChip">Mode: Detecting…</div>
  </header>

  <main class="container">
    <div class="dial" id="dial">
      <div class="ring"></div>
      <div class="vertical-guide" id="vGuide"></div>
      <div class="bubble-wrap" id="bubbleWrap">
        <div class="bubble" id="bubble"></div>
      </div>
      <div class="hud" id="hud">
        <div class="deg" id="degReadout">0.0°</div>
        <div class="dot"></div>
        <div class="axis" id="axisReadout">X: 0.0° · Y: 0.0°</div>
      </div>
    </div>
  </main>

  <div class="controls">
    <button class="primary" id="btnStart">Bắt đầu / Cấp quyền</button>
    <button class="ghost" id="btnZero">Zero (Hiệu chuẩn)</button>
    <button class="ghost" id="btnReset">Reset</button>
  </div>
  <p class="notice">
    Mẹo: đặt máy <b>nằm ngửa</b> để đo mặt phẳng (Surface) hoặc <b>dựng đứng</b> để đo tường/thanh (Vertical).
    Ở iOS bạn cần chạm “Bắt đầu / Cấp quyền” và chạy qua HTTPS.
  </p>

<script>
(function(){
  const btnStart = document.getElementById('btnStart');
  const btnZero  = document.getElementById('btnZero');
  const btnReset = document.getElementById('btnReset');
  const bubble   = document.getElementById('bubble');
  const bubbleWrap = document.getElementById('bubbleWrap');
  const dial     = document.getElementById('dial');
  const modeChip = document.getElementById('modeChip');
  const degReadout = document.getElementById('degReadout');
  const axisReadout = document.getElementById('axisReadout');
  const vGuide   = document.getElementById('vGuide');

  const LEVEL_OK = 0.3;     // trong khoảng ±0.3°
  const LEVEL_WARN = 1.0;   // ±1°
  const MAX_DEG_FOR_MOVE = 8; // map tối đa 8° ra biên bong bóng

  let hasStarted = false;
  let offsets = { beta: 0, gamma: 0 }; // hiệu chuẩn
  let lastMode = null; // "surface" | "vertical"
  let lastBuzz = 0;

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function now(){ return performance.now(); }

  function setMode(mode){
    if(mode === lastMode) return;
    lastMode = mode;
    modeChip.textContent = `Mode: ${mode === 'surface' ? 'Surface' : 'Vertical'}`;
    vGuide.style.display = (mode === 'vertical') ? 'block' : 'none';
  }

  function colorByError(err){
    if(err <= LEVEL_OK) return 'ok';
    if(err <= LEVEL_WARN) return 'warn';
    return 'bad';
  }

  function updateOutline(err){
    dial.classList.remove('ok', 'warn', 'bad');
    dial.classList.add(colorByError(err));
  }

  function haptic(){
    try{
      if(navigator.vibrate) navigator.vibrate(8);
    }catch(e){}
  }

  function beep(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type='sine'; o.frequency.value=880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime+0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.06);
      o.start(); o.stop(ctx.currentTime+0.08);
      setTimeout(()=>ctx.close(),120);
    }catch(e){}
  }

  function mapToBubble(xDeg, yDeg){
    // Map ±MAX_DEG_FOR_MOVE° -> ±40% của wrap
    const wrapRect = bubbleWrap.getBoundingClientRect();
    const radius = wrapRect.width/2;
    const maxPx = radius * 0.85;

    const x = clamp((xDeg / MAX_DEG_FOR_MOVE) * maxPx, -maxPx, maxPx);
    const y = clamp((yDeg / MAX_DEG_FOR_MOVE) * maxPx, -maxPx, maxPx);

    bubble.style.left = `calc(50% + ${x}px)`;
    bubble.style.top  = `calc(50% + ${y}px)`;
  }

  function pretty(n){ return (Math.round(n*10)/10).toFixed(1); }

  function handleOrientation(e){
    // iOS Safari: alpha(0-360), beta(-180..180), gamma(-90..90).
    // Ta chỉ cần beta (pitch) & gamma (roll).
    let beta = e.beta ?? 0;   // X tilt (trước-sau)
    let gamma= e.gamma ?? 0;  // Y tilt (trái-phải)

    // Trừ offsets để có "Zero"
    beta -= offsets.beta;
    gamma-= offsets.gamma;

    // Phát hiện mode:
    // Khi máy nằm ngửa: |beta| ~ 0; khi dựng đứng: |beta| ~ 90
    const mode = (Math.abs(Math.abs(e.beta) - 90) < 15) ? 'vertical' : 'surface';
    setMode(mode);

    // Tính sai số và hiển thị:
    if(mode === 'surface'){
      // 0° khi beta≈0, gamma≈0
      const err = Math.hypot(beta, gamma);
      updateOutline(Math.abs(err));
      mapToBubble(gamma, beta); // đảo trục để cảm giác tự nhiên
      degReadout.textContent = `${pretty(err)}°`;
      axisReadout.textContent = `X: ${pretty(beta)}° · Y: ${pretty(gamma)}°`;

      if(err <= LEVEL_OK && now()-lastBuzz>750){
        lastBuzz = now(); haptic(); beep();
      }
    }else{
      // Vertical: mong muốn beta≈±90, gamma≈0.
      // Chuyển về sai số so với 90° cho beta và 0° cho gamma.
      const betaErr = Math.abs(90 - Math.abs(e.beta - offsets.beta)); // dùng e.beta gốc cho logic 90°
      const roll = gamma;
      const err = Math.hypot(betaErr, roll);

      updateOutline(err);
      // Trong vertical, di chuyển bong bóng chủ yếu theo gamma (trái-phải),
      // còn betaErr biểu diễn theo trục Y để người dùng thấy cần ngửa/úp thêm.
      mapToBubble(roll, (betaErr * (roll>=0?1:1)) * (roll>=0?1:1) ); // đơn giản hóa

      degReadout.textContent = `${pretty(err)}°`;
      axisReadout.textContent = `β→90°: ${pretty(betaErr)}° · γ: ${pretty(roll)}°`;

      if(err <= LEVEL_OK && now()-lastBuzz>750){
        lastBuzz = now(); haptic(); beep();
      }
    }
  }

  async function start(){
    if(hasStarted) return;
    // iOS 13+: cần xin quyền
    try{
      if(typeof DeviceOrientationEvent !== 'undefined' &&
         typeof DeviceOrientationEvent.requestPermission === 'function'){
        const res = await DeviceOrientationEvent.requestPermission();
        if(res !== 'granted') { alert('Bạn cần cấp quyền “Motion & Orientation”.'); return; }
      }
    }catch(e){ /* ignore */ }

    window.addEventListener('deviceorientation', handleOrientation, true);
    hasStarted = true;
    modeChip.textContent = 'Mode: Detecting…';
    btnStart.textContent = 'Đang nhận cảm biến…';
    btnStart.disabled = true;
  }

  btnStart.addEventListener('click', start);

  btnZero.addEventListener('click', ()=>{
    // Lấy snapshot nhanh từ sự kiện gần nhất (không có -> không làm gì)
    // Trên iOS, chúng ta không có giá trị hiện tại ngoài event, nên hướng dẫn:
    // Khi người dùng bấm Zero, ta tạm thời nghe 1 frame để lấy offset.
    let got = false;
    function once(e){
      if(got) return;
      got = true;
      offsets.beta = e.beta ?? 0;
      offsets.gamma= e.gamma ?? 0;
      window.removeEventListener('deviceorientation', once, true);
      // Hiển thị 0 ngay lập tức
      degReadout.textContent = `0.0°`;
    }
    window.addEventListener('deviceorientation', once, true);
  });

  btnReset.addEventListener('click', ()=>{
    offsets = { beta:0, gamma:0 };
  });

  // Tự giảm chuyển động bong bóng (mượt hơn) — optional
  // (Ở đây mapToBubble gọi trực tiếp; nếu muốn smoothing: wrap thêm tween.)
})();
</script>
</body>
</html>
