<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Level — HTML/CSS/JS (Auto Zero)</title>
<style>
  :root{
    --bg:#0f1115; --ring:#1f2430; --tick:#2f3644; --text:#e8ecf3;
    --accent:#6ee7b7; --warn:#f59e0b; --danger:#ef4444;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:flex; flex-direction:column; align-items:center; gap:8px;
    -webkit-user-select:none; user-select:none; touch-action:manipulation;
  }
  header{padding:14px 16px 0; width:100%; max-width:480px; box-sizing:border-box;
    display:flex; justify-content:space-between; align-items:center; gap:8px;}
  .title{font-weight:600; letter-spacing:.2px; opacity:.9}
  .mode-chip{font-size:12px; padding:6px 10px; border-radius:999px;
    background:#1a1f29; border:1px solid #222836; opacity:.9}
  .container{width:100%; max-width:480px; aspect-ratio:1/1; position:relative; margin:auto;
    display:grid; place-items:center; padding:12px; box-sizing:border-box;}
  .dial{width:100%; height:100%; border-radius:50%;
    background:radial-gradient(120% 120% at 50% 50%, #151922 0%, #0e1118 60%, #0c0f15 100%);
    position:relative; box-shadow: inset 0 0 0 1px #1c2230, inset 0 0 40px rgba(0,0,0,.35);}
  .dial::before, .dial::after{content:""; position:absolute; inset:10%; border-radius:50%;
    box-shadow:0 -35% 0 -31% var(--tick), 0 35% 0 -31% var(--tick),
               35% 0 0 -31% var(--tick), -35% 0 0 -31% var(--tick);}
  .ring{position:absolute; inset:6%; border-radius:50%; border:2px solid var(--ring);}
  .bubble-wrap{position:absolute; inset:22%; border-radius:50%; pointer-events:none;}
  .bubble{
    --shadow: rgba(0,0,0,.55);
    position:absolute; left:50%; top:50%; transform:translate(-50%, -50%);
    width:28%; height:28%; border-radius:50%;
    background: radial-gradient(120% 120% at 30% 30%, rgba(255,255,255,.45), rgba(255,255,255,.12) 35%, rgba(255,255,255,.08) 55%, rgba(255,255,255,0) 70%),
                radial-gradient(100% 100% at 70% 70%, rgba(110,231,183,.35), rgba(110,231,183,.05) 60%, rgba(110,231,183,0) 75%);
    box-shadow: inset 0 2px 8px rgba(255,255,255,.25), 0 8px 18px var(--shadow), 0 2px 8px var(--shadow);
    border:1px solid rgba(255,255,255,.12); transition: box-shadow .15s ease;
  }
  .vertical-guide{position:absolute; left:50%; top:8%; bottom:8%; width:3px; transform:translateX(-50%);
    background:linear-gradient(to bottom, #273041, #1b2230); border-radius:2px; opacity:.7; display:none;}
  .hud{
    position:absolute; bottom:18px; left:50%; transform:translateX(-50%);
    display:flex; gap:10px; align-items:center; font-variant-numeric: tabular-nums;
    background:#121722; border:1px solid #22283a; border-radius:12px; padding:8px 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,.35);
  }
  .deg{ font-size:20px; font-weight:600 } .axis{ font-size:12px; opacity:.8 } .dot{ width:6px; height:6px; border-radius:50%; background:#344055 }
  .controls{width:100%; max-width:480px; box-sizing:border-box; padding:0 16px 20px;
    display:flex; gap:10px; justify-content:space-between; align-items:center;}
  button{appearance:none; border:none; cursor:pointer; color:var(--text); font-weight:600;
    background:#1b2230; border:1px solid #222a3a; padding:12px 14px; border-radius:12px;
    box-shadow: 0 4px 14px rgba(0,0,0,.25);}
  button:active{ transform:translateY(1px) } .primary{ background:#0f1729; border-color:#223049 } .ghost{ background:#161c28 }
  .notice{font-size:13px; opacity:.8; line-height:1.35; padding:0 16px 12px; max-width:520px; text-align:center;}
  .ok { outline:2px solid var(--accent); outline-offset:-2px } .warn { outline:2px solid var(--warn); outline-offset:-2px } .bad { outline:2px solid var(--danger); outline-offset:-2px }

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:80px; transform:translateX(-50%) translateY(20px);
    opacity:0; transition: all .25s ease; background:#0e1524; border:1px solid #223049; color:var(--text);
    padding:10px 14px; border-radius:12px; font-size:14px; box-shadow: 0 10px 24px rgba(0,0,0,.4);
    pointer-events:none;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }
</style>
</head>
<body>
  <header>
    <div class="title">Level</div>
    <div class="mode-chip" id="modeChip">Mode: Detecting…</div>
  </header>

  <main class="container">
    <div class="dial" id="dial">
      <div class="ring"></div>
      <div class="vertical-guide" id="vGuide"></div>
      <div class="bubble-wrap" id="bubbleWrap"><div class="bubble" id="bubble"></div></div>
      <div class="hud" id="hud">
        <div class="deg" id="degReadout">0.0°</div><div class="dot"></div>
        <div class="axis" id="axisReadout">X: 0.0° · Y: 0.0°</div>
      </div>
    </div>
  </main>

  <div class="controls">
    <button class="primary" id="btnStart">Bắt đầu / Cấp quyền</button>
    <button class="ghost" id="btnZero">Zero (Hiệu chuẩn)</button>
    <button class="ghost" id="btnReset">Reset</button>
    <button class="ghost" id="btnAuto">Auto Zero: ON</button>
  </div>
  <p class="notice">
    Giữ máy <b>yên ~1.2s</b> để tự hiệu chuẩn (Auto Zero). Trên iOS cần chạm “Bắt đầu / Cấp quyền” và chạy qua HTTPS.
  </p>
  <div class="toast" id="toast">Auto Zero ✓</div>

<script>
(function(){
  const btnStart = document.getElementById('btnStart');
  const btnZero  = document.getElementById('btnZero');
  const btnReset = document.getElementById('btnReset');
  const btnAuto  = document.getElementById('btnAuto');
  const bubble   = document.getElementById('bubble');
  const bubbleWrap = document.getElementById('bubbleWrap');
  const dial     = document.getElementById('dial');
  const modeChip = document.getElementById('modeChip');
  const degReadout = document.getElementById('degReadout');
  const axisReadout = document.getElementById('axisReadout');
  const vGuide   = document.getElementById('vGuide');
  const toastEl  = document.getElementById('toast');

  const LEVEL_OK = 0.3;
  const LEVEL_WARN = 1.0;
  const MAX_DEG_FOR_MOVE = 8;

  // Auto Zero config
  const STABLE_WINDOW_MS = 1200;     // cần yên trong ~1.2s
  const STD_THRESH = 0.08;           // độ lệch chuẩn (°) tối đa trong cửa sổ
  const DRIFT_THRESH = 0.04;         // trung bình vận tốc (°/s) trong cửa sổ
  const AUTO_ZERO_COOLDOWN = 6000;   // 6s giữa 2 lần auto
  let autoZeroEnabled = true;

  let hasStarted = false;
  let offsets = { beta: 0, gamma: 0 };
  let lastMode = null; // 'surface' | 'vertical'
  let lastBuzz = 0;

  // Vòng đệm mẫu cho Auto Zero
  const samples = [];
  function now(){ return performance.now(); }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function showToast(msg='Auto Zero ✓'){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 1000);
  }
  function haptic(){ try{ if(navigator.vibrate) navigator.vibrate(8); }catch(e){} }
  function beep(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime+0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.06);
      o.start(); o.stop(ctx.currentTime+0.08); setTimeout(()=>ctx.close(),120);
    }catch(e){}
  }
  function setMode(mode){
    if(mode === lastMode) return;
    lastMode = mode;
    modeChip.textContent = `Mode: ${mode === 'surface' ? 'Surface' : 'Vertical'}`;
    vGuide.style.display = (mode === 'vertical') ? 'block' : 'none';
    // đổi mode -> reset samples để tránh auto-zero sai
    samples.length = 0;
  }
  function colorByError(err){ if(err <= LEVEL_OK) return 'ok'; if(err <= LEVEL_WARN) return 'warn'; return 'bad'; }
  function updateOutline(err){
    dial.classList.remove('ok','warn','bad'); dial.classList.add(colorByError(err));
  }
  function mapToBubble(xDeg, yDeg){
    const wrapRect = bubbleWrap.getBoundingClientRect();
    const radius = wrapRect.width/2; const maxPx = radius * 0.85;
    const x = clamp((xDeg / MAX_DEG_FOR_MOVE) * maxPx, -maxPx, maxPx);
    const y = clamp((yDeg / MAX_DEG_FOR_MOVE) * maxPx, -maxPx, maxPx);
    bubble.style.left = `calc(50% + ${x}px)`; bubble.style.top  = `calc(50% + ${y}px)`;
  }
  function pretty(n){ return (Math.round(n*10)/10).toFixed(1); }

  // ==== Auto Zero detector ====
  let lastAutoZeroAt = 0;
  function maybeAutoZero(){
    if(!autoZeroEnabled) return;
    const t = now();
    if(t - lastAutoZeroAt < AUTO_ZERO_COOLDOWN) return;
    // lấy cửa sổ STABLE_WINDOW_MS
    const windowStart = t - STABLE_WINDOW_MS;
    const windowSamples = samples.filter(s => s.t >= windowStart);
    if(windowSamples.length < 12) return; // chưa đủ mẫu

    // Tính trung bình & độ lệch chuẩn
    const mean = (arr, f)=> arr.reduce((a,b)=>a+f(b),0)/arr.length;
    const mB = mean(windowSamples, s=>s.beta);
    const mG = mean(windowSamples, s=>s.gamma);
    const std = (arr, f, m)=> Math.sqrt(arr.reduce((a,b)=>a+Math.pow(f(b)-m,2),0)/arr.length);
    const sB = std(windowSamples, s=>s.beta, mB);
    const sG = std(windowSamples, s=>s.gamma, mG);

    // Ước lượng vận tốc trung bình (độ/giây)
    let velSumB = 0, velSumG = 0, count=0;
    for(let i=1;i<windowSamples.length;i++){
      const a = windowSamples[i-1], b = windowSamples[i];
      const dt = (b.t - a.t)/1000;
      if(dt>0){
        velSumB += Math.abs((b.beta - a.beta)/dt);
        velSumG += Math.abs((b.gamma - a.gamma)/dt);
        count++;
      }
    }
    const vB = count? velSumB/count : 0;
    const vG = count? velSumG/count : 0;

    const stable = (sB<=STD_THRESH && sG<=STD_THRESH && vB<=DRIFT_THRESH && vG<=DRIFT_THRESH);
    if(!stable) return;

    // -> chốt Zero = trung bình cửa sổ
    offsets.beta = (offsets.beta + mB)/2;   // blend nhẹ để tránh giật
    offsets.gamma= (offsets.gamma+ mG)/2;

    lastAutoZeroAt = t;
    showToast('Auto Zero ✓');
    haptic(); beep();
  }

  function handleOrientation(e){
    // gốc
    const rawBeta = e.beta ?? 0;   // X tilt
    const rawGamma= e.gamma ?? 0;  // Y tilt

    // xác định mode từ beta gốc (không trừ offset)
    const mode = (Math.abs(Math.abs(rawBeta) - 90) < 15) ? 'vertical' : 'surface';
    setMode(mode);

    // trừ offset sau khi đã chốt mode
    let beta = rawBeta - offsets.beta;
    let gamma= rawGamma - offsets.gamma;

    // đẩy mẫu vào buffer (giữ 3s gần nhất)
    samples.push({t: now(), beta: rawBeta, gamma: rawGamma});
    const cutoff = now() - 3000;
    while(samples.length && samples[0].t < cutoff) samples.shift();

    // Auto Zero nếu ổn định
    maybeAutoZero();

    if(mode === 'surface'){
      const err = Math.hypot(beta, gamma);
      updateOutline(Math.abs(err));
      mapToBubble(gamma, beta); // đảo trục cho trực quan
      degReadout.textContent = `${pretty(err)}°`;
      axisReadout.textContent = `X: ${pretty(beta)}° · Y: ${pretty(gamma)}°`;
      if(err <= LEVEL_OK && now()-lastBuzz>750){ lastBuzz = now(); haptic(); beep(); }
    }else{
      // vertical: muốn beta≈±90, gamma≈0 — hiển thị theo sai số
      const betaErr = Math.abs(90 - Math.abs(rawBeta - offsets.beta)); // dùng raw cho mục tiêu 90°
      const roll = gamma;
      const err = Math.hypot(betaErr, roll);
      updateOutline(err);
      mapToBubble(roll, betaErr);
      degReadout.textContent = `${pretty(err)}°`;
      axisReadout.textContent = `β→90°: ${pretty(betaErr)}° · γ: ${pretty(roll)}°`;
      if(err <= LEVEL_OK && now()-lastBuzz>750){ lastBuzz = now(); haptic(); beep(); }
    }
  }

  async function start(){
    if(hasStarted) return;
    try{
      if(typeof DeviceOrientationEvent !== 'undefined' &&
         typeof DeviceOrientationEvent.requestPermission === 'function'){
        const res = await DeviceOrientationEvent.requestPermission();
        if(res !== 'granted'){ alert('Bạn cần cấp quyền “Motion & Orientation”.'); return; }
      }
    }catch(e){}
    window.addEventListener('deviceorientation', handleOrientation, true);
    hasStarted = true;
    modeChip.textContent = 'Mode: Detecting…';
    btnStart.textContent = 'Đang nhận cảm biến…'; btnStart.disabled = true;
  }

  btnStart.addEventListener('click', start);

  // Zero thủ công (vẫn giữ)
  btnZero.addEventListener('click', ()=>{
    let got = false;
    function once(e){
      if(got) return; got = true;
      offsets.beta = e.beta ?? 0; offsets.gamma = e.gamma ?? 0;
      window.removeEventListener('deviceorientation', once, true);
      showToast('Zero ✓'); haptic(); beep();
      degReadout.textContent = `0.0°`;
    }
    window.addEventListener('deviceorientation', once, true);
  });

  btnReset.addEventListener('click', ()=>{
    offsets = { beta:0, gamma:0 };
    showToast('Reset offsets'); haptic();
  });

  btnAuto.addEventListener('click', ()=>{
    autoZeroEnabled = !autoZeroEnabled;
    btnAuto.textContent = `Auto Zero: ${autoZeroEnabled?'ON':'OFF'}`;
    showToast(`Auto Zero ${autoZeroEnabled?'ON':'OFF'}`);
  });
})();
</script>
</body>
</html>
