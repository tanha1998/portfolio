<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Level Web</title>
<style>
  body{margin:0;background:#0f1115;color:#e8ecf3;
    font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;height:100vh;}
  .dial{width:90vmin;height:90vmin;border-radius:50%;
    background:#151922;position:relative;box-shadow:inset 0 0 0 2px #222a3a;}
  .bubble{position:absolute;width:15%;height:15%;border-radius:50%;
    left:50%;top:50%;transform:translate(-50%,-50%);
    background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.5),rgba(0,0,0,.1));
    border:2px solid #6ee7b7;}
  .hud{margin-top:10px;font-size:20px;}
  .controls{margin-top:10px;display:flex;gap:10px}
  button{padding:10px 14px;border-radius:8px;border:none;background:#1b2230;color:#fff;cursor:pointer}
  .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%) translateY(20px);
    opacity:0;transition:all .3s;background:#0e1524;border:1px solid #223049;color:#fff;
    padding:8px 12px;border-radius:8px}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
  <div class="dial">
    <div class="bubble" id="bubble"></div>
  </div>
  <div class="hud">
    <span id="deg">0.0°</span>
  </div>
  <div class="controls">
    <button id="btnStart">Bắt đầu</button>
    <button id="btnZero">Zero</button>
    <button id="btnReset">Reset</button>
  </div>
  <div class="toast" id="toast">✓ Zero</div>

<script>
(function(){
  const bubble = document.getElementById("bubble");
  const degEl = document.getElementById("deg");
  const btnStart = document.getElementById("btnStart");
  const btnZero = document.getElementById("btnZero");
  const btnReset= document.getElementById("btnReset");
  const toastEl = document.getElementById("toast");

  // offsets lưu sai số
  let offsets = { beta:0, gamma:0 };
  const saved = localStorage.getItem("offsets");
  if(saved) offsets = JSON.parse(saved);

  // moving average buffer
  const bufSize = 10;
  let bufBeta=[], bufGamma=[];

  // auto zero
  const samples = [];
  let lastAuto=0;

  function showToast(msg){
    toastEl.textContent=msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"),1000);
  }

  function smoothPush(arr,val){
    arr.push(val);
    if(arr.length>bufSize) arr.shift();
    return arr.reduce((a,b)=>a+b,0)/arr.length;
  }

  function handle(e){
    let rawBeta=e.beta??0, rawGamma=e.gamma??0;
    // trừ offset (calibration)
    let beta=rawBeta - offsets.beta;
    let gamma=rawGamma - offsets.gamma;

    // lọc trung bình
    beta = smoothPush(bufBeta,beta);
    gamma= smoothPush(bufGamma,gamma);

    // sai số tổng
    const err=Math.hypot(beta,gamma);
    degEl.textContent=err.toFixed(1)+"°";

    // vẽ bong bóng
    const wrap=document.querySelector(".dial").getBoundingClientRect();
    const maxPx=wrap.width/2*0.7;
    const x=(gamma/8)*maxPx;
    const y=(beta/8)*maxPx;
    bubble.style.left=`calc(50% + ${x}px)`;
    bubble.style.top=`calc(50% + ${y}px)`;

    // ghi lại mẫu cho auto zero
    const t=performance.now();
    samples.push({t,rawBeta,rawGamma});
    while(samples.length && samples[0].t<t-1500) samples.shift();

    // kiểm tra auto zero
    if(samples.length>8 && t-lastAuto>5000){
      const avgB=samples.reduce((a,b)=>a+b.rawBeta,0)/samples.length;
      const avgG=samples.reduce((a,b)=>a+b.rawGamma,0)/samples.length;
      const varB=Math.sqrt(samples.reduce((a,b)=>a+Math.pow(b.rawBeta-avgB,2),0)/samples.length);
      const varG=Math.sqrt(samples.reduce((a,b)=>a+Math.pow(b.rawGamma-avgG,2),0)/samples.length);
      if(varB<0.08 && varG<0.08){
        offsets.beta=avgB; offsets.gamma=avgG;
        localStorage.setItem("offsets",JSON.stringify(offsets));
        lastAuto=t;
        showToast("✓ Auto Zero");
      }
    }
  }

  async function start(){
    if(typeof DeviceOrientationEvent!=="undefined" &&
       typeof DeviceOrientationEvent.requestPermission==="function"){
      const res=await DeviceOrientationEvent.requestPermission();
      if(res!=="granted"){ alert("Cần cấp quyền cảm biến"); return; }
    }
    window.addEventListener("deviceorientation",handle,true);
    btnStart.disabled=true; btnStart.textContent="Đang chạy...";
  }

  btnStart.onclick=start;
  btnZero.onclick=()=>{
    window.addEventListener("deviceorientation",function once(e){
      offsets.beta=e.beta??0;
      offsets.gamma=e.gamma??0;
      localStorage.setItem("offsets",JSON.stringify(offsets));
      showToast("✓ Zero");
      window.removeEventListener("deviceorientation",once,true);
    },true);
  };
  btnReset.onclick=()=>{
    offsets={beta:0,gamma:0};
    localStorage.removeItem("offsets");
    showToast("Reset");
  };
})();
</script>
</body>
</html>
